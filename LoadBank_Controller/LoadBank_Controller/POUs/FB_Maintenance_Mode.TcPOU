<?xml version="1.0" encoding="utf-8"?>
<TcPlcObject Version="1.1.0.1" ProductVersion="3.1.4024.16">
  <POU Name="FB_Maintenance_Mode" Id="{7d12e330-6b4b-4cd7-9e92-021545592ba8}" SpecialFunc="None">
    <Declaration><![CDATA[FUNCTION_BLOCK FB_Maintenance_Mode
// ============================================
// FB_Maintenance_Mode
// Full maintenance mode with manual test + self-test
// Migrated from PRG_Maint_Mode features
// ============================================
VAR_INPUT
    // Mode control
    Mode_Active             : BOOL;
    Master_Enable           : BOOL;
    Emergency_Active        : BOOL;
    
    // Configuration
    Number_Of_Steps         : UINT := 10;
    Power_Tolerance_Percent : REAL := 10.0;
    Feedback_Timeout_ms     : UINT := 3000;
    Test_Duration_Sec       : UINT := 5;
    Delay_Between_Steps_ms  : UINT := 1000;
    Cycle_Time_ms           : UINT := 10;
    
    // Manual test commands
    Selected_Step           : UINT := 1;
    Toggle_Fan_Cmd          : BOOL;
    Toggle_Step_Cmd         : BOOL;
    Reset_Test_Cmd          : BOOL;
    
    // Self-test commands
    Self_Test_Start         : BOOL;
    Self_Test_Stop          : BOOL;
    
    // Feedback inputs
    Fan_Contactor_FB        : BOOL;
    Fan_Pressure_OK         : BOOL;
    Fan_Overload_OK         : BOOL;
    Step_Feedback           : ARRAY[1..LB_NUMBER_OF_STEPS] OF BOOL;
    Step_Power_kW           : ARRAY[1..LB_NUMBER_OF_STEPS] OF REAL;
    Step_Rated_Power        : ARRAY[1..LB_NUMBER_OF_STEPS] OF REAL;
    Step_Quarantined        : ARRAY[1..LB_NUMBER_OF_STEPS] OF BOOL;
END_VAR

VAR_OUTPUT
    // Status
    Mode_Ready              : BOOL;
    
    // Outputs to control
    Fan_Output              : BOOL;
    Step_Output             : ARRAY[1..LB_NUMBER_OF_STEPS] OF BOOL;
    
    // Quarantine signals (active for 1 scan)
    Quarantine_Step         : UINT := 0;
    Unquarantine_Step       : UINT := 0;
    
    // Manual test status
    Feedback_Match          : BOOL;
    Response_Time_ms        : UINT;
    Power_Within_Tolerance  : BOOL;
    
    // Self-test status
    Self_Test_Running       : BOOL;
    Self_Test_Complete      : BOOL;
    Self_Test_Current_Step  : UINT;
    Self_Test_Timer_Sec     : UINT;
    Self_Test_Pass_Count    : UINT;
    Self_Test_Fail_Count    : UINT;
    
    // Status message
    Status_Message          : STRING(100);
END_VAR

VAR
    // Internal state
    i                       : UINT;
    Self_Test_State         : UINT := 0;
    
    // Edge detection
    Toggle_Fan_Prev         : BOOL;
    Toggle_Step_Prev        : BOOL;
    Reset_Test_Prev         : BOOL;
    Self_Test_Start_Prev    : BOOL;
    Self_Test_Stop_Prev     : BOOL;
    
    // Timers
    Feedback_Timer          : TON;
    Test_Duration_Timer     : TON;
    Delay_Timer             : TON;
    Response_Timer          : TON;
    
    // Self-test variables
    Test_Step_Index         : UINT;
    Test_Start_Time_ms      : UDINT;
    Test_Power_At_Start     : REAL;
    Waiting_For_Feedback    : BOOL;
    
    // Power calculation
    Power_Error_Percent     : REAL;
    Expected_Power          : REAL;
    Measured_Power          : REAL;
END_VAR]]></Declaration>
    <Implementation>
      <ST><![CDATA[
// ============================================
// SAFETY CHECKS
// ============================================
IF NOT Mode_Active THEN
    // Reset all outputs
    Fan_Output := FALSE;
    FOR i := 1 TO LB_NUMBER_OF_STEPS DO
        Step_Output[i] := FALSE;
    END_FOR;
    
    Self_Test_State := 0;
    Self_Test_Running := FALSE;
    Self_Test_Complete := FALSE;
    Mode_Ready := FALSE;
    Quarantine_Step := 0;
    Unquarantine_Step := 0;
    Status_Message := 'Maintenance mode not active';
    RETURN;
END_IF;

IF Emergency_Active THEN
    // Emergency - shut down
    Fan_Output := FALSE;
    FOR i := 1 TO LB_NUMBER_OF_STEPS DO
        Step_Output[i] := FALSE;
    END_FOR;
    
    Self_Test_State := 0;
    Self_Test_Running := FALSE;
    Mode_Ready := FALSE;
    Status_Message := 'EMERGENCY ACTIVE';
    RETURN;
END_IF;

IF NOT Master_Enable THEN
    Mode_Ready := FALSE;
    Status_Message := 'Master enable required';
    RETURN;
END_IF;

Mode_Ready := TRUE;

// Clear one-shot quarantine signals
Quarantine_Step := 0;
Unquarantine_Step := 0;

// ============================================
// MANUAL FAN TOGGLE (Rising Edge)
// ============================================
IF Toggle_Fan_Cmd AND NOT Toggle_Fan_Prev THEN
    Fan_Output := NOT Fan_Output;
    IF Fan_Output THEN
        Status_Message := 'Fan ON - Manual test';
    ELSE
        Status_Message := 'Fan OFF';
    END_IF;
END_IF;
Toggle_Fan_Prev := Toggle_Fan_Cmd;

// ============================================
// MANUAL STEP TOGGLE (Rising Edge)
// Requires fan running and pressure OK
// ============================================
IF Toggle_Step_Cmd AND NOT Toggle_Step_Prev THEN
    IF Selected_Step > 0 AND Selected_Step <= Number_Of_Steps THEN
        IF Fan_Contactor_FB AND Fan_Pressure_OK THEN
            Step_Output[Selected_Step] := NOT Step_Output[Selected_Step];
            IF Step_Output[Selected_Step] THEN
                Status_Message := CONCAT('Step ', UINT_TO_STRING(Selected_Step));
                Status_Message := CONCAT(Status_Message, ' ON');
                // Start response timer
                Response_Timer(IN := FALSE);
                Response_Timer(IN := TRUE, PT := T#10s);
                Waiting_For_Feedback := TRUE;
            ELSE
                Status_Message := CONCAT('Step ', UINT_TO_STRING(Selected_Step));
                Status_Message := CONCAT(Status_Message, ' OFF');
                Waiting_For_Feedback := FALSE;
            END_IF;
        ELSE
            Status_Message := 'Fan must be running with pressure';
        END_IF;
    ELSE
        Status_Message := 'Invalid step number';
    END_IF;
END_IF;
Toggle_Step_Prev := Toggle_Step_Cmd;

// ============================================
// RESET TEST (Rising Edge)
// ============================================
IF Reset_Test_Cmd AND NOT Reset_Test_Prev THEN
    // Turn off all outputs
    Fan_Output := FALSE;
    FOR i := 1 TO LB_NUMBER_OF_STEPS DO
        Step_Output[i] := FALSE;
    END_FOR;
    
    // Reset self-test
    Self_Test_State := 0;
    Self_Test_Running := FALSE;
    Self_Test_Complete := FALSE;
    Self_Test_Pass_Count := 0;
    Self_Test_Fail_Count := 0;
    
    Status_Message := 'Test reset';
END_IF;
Reset_Test_Prev := Reset_Test_Cmd;

// ============================================
// CONTINUOUS FEEDBACK MATCH CHECK
// ============================================
IF Selected_Step > 0 AND Selected_Step <= Number_Of_Steps THEN
    Feedback_Match := (Step_Output[Selected_Step] = Step_Feedback[Selected_Step]);
    
    // Measure response time
    IF Waiting_For_Feedback THEN
        Response_Timer(IN := TRUE, PT := T#10s);
        IF Step_Feedback[Selected_Step] THEN
            Response_Time_ms := TIME_TO_UINT(Response_Timer.ET);
            Waiting_For_Feedback := FALSE;
        END_IF;
    END_IF;
ELSE
    Feedback_Match := FALSE;
END_IF;

// ============================================
// CONTINUOUS POWER TOLERANCE CHECK
// ============================================
IF Selected_Step > 0 AND Selected_Step <= Number_Of_Steps THEN
    IF Step_Output[Selected_Step] AND Step_Feedback[Selected_Step] THEN
        Expected_Power := Step_Rated_Power[Selected_Step];
        Measured_Power := Step_Power_kW[Selected_Step];
        
        IF Expected_Power > 0.0 THEN
            Power_Error_Percent := ABS(Measured_Power - Expected_Power) / Expected_Power * 100.0;
            Power_Within_Tolerance := (Power_Error_Percent <= Power_Tolerance_Percent);
        ELSE
            Power_Within_Tolerance := TRUE;
        END_IF;
    ELSE
        Power_Within_Tolerance := TRUE;
    END_IF;
ELSE
    Power_Within_Tolerance := TRUE;
END_IF;

// ============================================
// SELF-TEST START (Rising Edge)
// ============================================
IF Self_Test_Start AND NOT Self_Test_Start_Prev THEN
    IF Fan_Contactor_FB AND Fan_Pressure_OK AND Fan_Overload_OK THEN
        Self_Test_State := 10;
        Self_Test_Running := TRUE;
        Self_Test_Complete := FALSE;
        Self_Test_Pass_Count := 0;
        Self_Test_Fail_Count := 0;
        Test_Step_Index := 0;
        Status_Message := 'Self-test starting...';
    ELSE
        Status_Message := 'Fan must be running for self-test';
    END_IF;
END_IF;
Self_Test_Start_Prev := Self_Test_Start;

// ============================================
// SELF-TEST STOP (Rising Edge)
// ============================================
IF Self_Test_Stop AND NOT Self_Test_Stop_Prev THEN
    IF Self_Test_Running THEN
        // Turn off current test step
        IF Test_Step_Index > 0 AND Test_Step_Index <= Number_Of_Steps THEN
            Step_Output[Test_Step_Index] := FALSE;
        END_IF;
        
        Self_Test_State := 0;
        Self_Test_Running := FALSE;
        Status_Message := 'Self-test stopped';
    END_IF;
END_IF;
Self_Test_Stop_Prev := Self_Test_Stop;

// ============================================
// SELF-TEST STATE MACHINE
// ============================================
CASE Self_Test_State OF

    0: // IDLE
        Self_Test_Running := FALSE;
        Self_Test_Timer_Sec := 0;
        
    10: // START NEXT STEP
        Test_Step_Index := Test_Step_Index + 1;
        
        // Skip quarantined steps
        WHILE Test_Step_Index <= Number_Of_Steps AND Step_Quarantined[Test_Step_Index] DO
            Test_Step_Index := Test_Step_Index + 1;
        END_WHILE;
        
        IF Test_Step_Index > Number_Of_Steps THEN
            // All steps tested
            Self_Test_State := 100;
        ELSE
            // Turn on this step
            Step_Output[Test_Step_Index] := TRUE;
            Self_Test_Current_Step := Test_Step_Index;
            Feedback_Timer(IN := FALSE);
            Feedback_Timer(IN := TRUE, PT := UINT_TO_TIME(Feedback_Timeout_ms));
            Status_Message := CONCAT('Testing step ', UINT_TO_STRING(Test_Step_Index));
            Self_Test_State := 20;
        END_IF;
        
    20: // WAIT FOR FEEDBACK
        Feedback_Timer(IN := TRUE, PT := UINT_TO_TIME(Feedback_Timeout_ms));
        
        // Check if fan stopped (abort)
        IF NOT Fan_Contactor_FB OR NOT Fan_Pressure_OK THEN
            Step_Output[Test_Step_Index] := FALSE;
            Self_Test_State := 0;
            Self_Test_Running := FALSE;
            Status_Message := 'Self-test aborted - fan stopped';
        ELSIF Step_Feedback[Test_Step_Index] THEN
            // Got feedback - start monitoring power
            Test_Duration_Timer(IN := FALSE);
            Test_Duration_Timer(IN := TRUE, PT := UINT_TO_TIME(Test_Duration_Sec * 1000));
            Status_Message := CONCAT('Step ', UINT_TO_STRING(Test_Step_Index));
            Status_Message := CONCAT(Status_Message, ' - monitoring power');
            Self_Test_State := 30;
        ELSIF Feedback_Timer.Q THEN
            // Timeout - feedback fault
            Step_Output[Test_Step_Index] := FALSE;
            Quarantine_Step := Test_Step_Index;
            Self_Test_Fail_Count := Self_Test_Fail_Count + 1;
            Status_Message := CONCAT('Step ', UINT_TO_STRING(Test_Step_Index));
            Status_Message := CONCAT(Status_Message, ' FAILED - no feedback');
            Delay_Timer(IN := FALSE);
            Self_Test_State := 90;
        END_IF;
        
    30: // MONITOR POWER FOR DURATION
        Test_Duration_Timer(IN := TRUE, PT := UINT_TO_TIME(Test_Duration_Sec * 1000));
        Self_Test_Timer_Sec := TIME_TO_UINT(Test_Duration_Timer.ET) / 1000;
        
        // Check if fan stopped (abort)
        IF NOT Fan_Contactor_FB OR NOT Fan_Pressure_OK THEN
            Step_Output[Test_Step_Index] := FALSE;
            Self_Test_State := 0;
            Self_Test_Running := FALSE;
            Status_Message := 'Self-test aborted - fan stopped';
        ELSIF NOT Step_Feedback[Test_Step_Index] THEN
            // Feedback lost during test
            Step_Output[Test_Step_Index] := FALSE;
            Quarantine_Step := Test_Step_Index;
            Self_Test_Fail_Count := Self_Test_Fail_Count + 1;
            Status_Message := CONCAT('Step ', UINT_TO_STRING(Test_Step_Index));
            Status_Message := CONCAT(Status_Message, ' FAILED - feedback lost');
            Delay_Timer(IN := FALSE);
            Self_Test_State := 90;
        ELSE
            // Check power tolerance
            Expected_Power := Step_Rated_Power[Test_Step_Index];
            Measured_Power := Step_Power_kW[Test_Step_Index];
            
            IF Expected_Power > 0.0 THEN
                Power_Error_Percent := ABS(Measured_Power - Expected_Power) / Expected_Power * 100.0;
                
                IF Power_Error_Percent > Power_Tolerance_Percent THEN
                    // Power out of tolerance
                    Step_Output[Test_Step_Index] := FALSE;
                    Quarantine_Step := Test_Step_Index;
                    Self_Test_Fail_Count := Self_Test_Fail_Count + 1;
                    Status_Message := CONCAT('Step ', UINT_TO_STRING(Test_Step_Index));
                    Status_Message := CONCAT(Status_Message, ' FAILED - power error');
                    Delay_Timer(IN := FALSE);
                    Self_Test_State := 90;
                END_IF;
            END_IF;
            
            // Duration complete?
            IF Test_Duration_Timer.Q THEN
                Self_Test_State := 80;
            END_IF;
        END_IF;
        
    80: // STEP PASSED
        Step_Output[Test_Step_Index] := FALSE;
        Self_Test_Pass_Count := Self_Test_Pass_Count + 1;
        
        // Unquarantine if it was quarantined
        IF Step_Quarantined[Test_Step_Index] THEN
            Unquarantine_Step := Test_Step_Index;
        END_IF;
        
        Status_Message := CONCAT('Step ', UINT_TO_STRING(Test_Step_Index));
        Status_Message := CONCAT(Status_Message, ' PASSED');
        
        Delay_Timer(IN := FALSE);
        Self_Test_State := 85;
        
    85: // DELAY BEFORE NEXT STEP
        Delay_Timer(IN := TRUE, PT := UINT_TO_TIME(Delay_Between_Steps_ms));
        
        IF Delay_Timer.Q THEN
            Delay_Timer(IN := FALSE);
            Self_Test_State := 10;
        END_IF;
        
    90: // STEP FAILED - QUARANTINE
        // Step already turned off and quarantine signal sent
        Delay_Timer(IN := TRUE, PT := UINT_TO_TIME(Delay_Between_Steps_ms));
        
        IF Delay_Timer.Q THEN
            Delay_Timer(IN := FALSE);
            Self_Test_State := 10;
        END_IF;
        
    100: // ALL STEPS COMPLETE
        Self_Test_Running := FALSE;
        Self_Test_Complete := TRUE;
        Self_Test_State := 0;
        Status_Message := CONCAT('Self-test complete. Pass: ', UINT_TO_STRING(Self_Test_Pass_Count));
        Status_Message := CONCAT(Status_Message, ' Fail: ');
        Status_Message := CONCAT(Status_Message, UINT_TO_STRING(Self_Test_Fail_Count));

END_CASE;
]]></ST>
    </Implementation>
  </POU>
</TcPlcObject>
